<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pose Detection v4 (Strict)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        video {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            z-index: 1;
        }
        canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            z-index: 2;
        }
        #status-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            width: 80%;
            text-align: center;
        }
        #message {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 2px solid #FF0000; /* 기본 빨강 테두리 */
        }
        #debug {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #ddd;
            text-shadow: 1px 1px 2px black;
        }
    </style>
    <!-- MediaPipe 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>
        <div id="status-box">
            <div id="message">로딩중...</div>
            <div id="debug"></div>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const messageDiv = document.getElementById('message');
        const debugDiv = document.getElementById('debug');

        // 좌표 변환 (반응형 대응)
        function toPixel(landmark, width, height) {
            return { x: landmark.x * width, y: landmark.y * height };
        }

        // 각도 계산
        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        // 수직 편차 계산
        function calculateVerticalDeviation(a, b) {
            const dx = Math.abs(b.x - a.x);
            const dy = Math.abs(b.y - a.y);
            const radians = Math.atan2(dx, dy); 
            return radians * 180.0 / Math.PI;
        }

        function onResults(results) {
            const width = videoElement.videoWidth;
            const height = videoElement.videoHeight;
            canvasElement.width = width;
            canvasElement.height = height;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, width, height);

            if (results.poseLandmarks) {
                const rawLm = results.poseLandmarks;
                const p = {};
                [11,12,13,14,15,16,23,24,25,26,27,28].forEach(index => {
                    p[index] = toPixel(rawLm[index], width, height);
                });

                // === [설정값] 엄격도 조절 ===
                const ARM_STRAIGHT_MIN = 160;   // 팔 펴짐 각도 (160도 이상)
                const KNEE_STRAIGHT_MIN = 165;  // 무릎 펴짐 각도 (165도 이상)
                const BODY_VERTICAL_MAX = 15;   // 몸 수직 기울기 허용오차 (15도 이내)

                // 1. 몸(Body) 검사: 왼쪽이나 오른쪽 중 한쪽이라도 완벽하게 서 있으면 인정
                
                // 왼쪽 몸 체크
                const leftTorsoDev = calculateVerticalDeviation(p[11], p[23]);
                const leftLegDev = calculateVerticalDeviation(p[23], p[27]);
                const leftKneeAngle = calculateAngle(p[23], p[25], p[27]);
                const leftBodyOk = (leftTorsoDev < BODY_VERTICAL_MAX) && 
                                   (leftLegDev < BODY_VERTICAL_MAX) && 
                                   (leftKneeAngle > KNEE_STRAIGHT_MIN);

                // 오른쪽 몸 체크
                const rightTorsoDev = calculateVerticalDeviation(p[12], p[24]);
                const rightLegDev = calculateVerticalDeviation(p[24], p[28]);
                const rightKneeAngle = calculateAngle(p[24], p[26], p[28]);
                const rightBodyOk = (rightTorsoDev < BODY_VERTICAL_MAX) && 
                                    (rightLegDev < BODY_VERTICAL_MAX) && 
                                    (rightKneeAngle > KNEE_STRAIGHT_MIN);

                const isBodyReady = leftBodyOk || rightBodyOk;

                // 2. 팔(Arm) 검사: 둘 중 하나라도 펴져 있으면 인정
                const leftArmAngle = calculateAngle(p[11], p[13], p[15]);
                const rightArmAngle = calculateAngle(p[12], p[14], p[16]);
                const isArmReady = (leftArmAngle > ARM_STRAIGHT_MIN) || (rightArmAngle > ARM_STRAIGHT_MIN);

                // === [최종 판정 로직] ===
                // 두 조건이 모두 True여야 함
                const isSuccess = isBodyReady && isArmReady;

                let mainText = "";
                let subText = "";
                let color = "#FF0000"; // 기본 빨강

                if (isSuccess) {
                    color = "#00FF00"; // 초록
                    mainText = "완벽합니다!";
                    subText = "몸 수직 O / 팔 펴짐 O";
                } else {
                    // 실패 원인 분석
                    if (!isBodyReady) {
                        mainText = "몸을 수직으로 세워주세요";
                        subText = `기울기: ${Math.round(Math.min(leftTorsoDev, rightTorsoDev))}° (목표: 15°이하)`;
                    } else if (!isArmReady) {
                        mainText = "몸은 좋습니다! 팔을 쭉 펴세요";
                        subText = `팔 각도: ${Math.round(Math.max(leftArmAngle, rightArmAngle))}° (목표: 160°이상)`;
                    } else {
                        mainText = "자세를 취해주세요";
                    }
                }

                // 화면 표시 업데이트
                messageDiv.innerText = mainText;
                messageDiv.style.borderColor = color;
                messageDiv.style.color = isSuccess ? "#00FF00" : "#FFFFFF";
                debugDiv.innerText = subText;

                // 스켈레톤 그리기
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                             {color: color, lineWidth: 4});
                drawLandmarks(canvasCtx, results.poseLandmarks,
                            {color: color, lineWidth: 2, radius: 4});
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });

        camera.start().then(() => {
            messageDiv.innerText = "카메라 시작됨\n전신이 나오게 서주세요";
        });
    </script>
</body>
</html>
